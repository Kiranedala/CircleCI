# version: 2
# jobs:
#   build:
#     working_directory: ~/CircleCI
#     docker:
#      - image: circleci/node:6.14.1-browsers
#     steps:
#       - checkout
#       - restore_cache:
#           key: CircleCI-{{ .Branch }}-{{ checksum "package.json" }}
#       - run: npm install
#       - save_cache:
#           key: CircleCI-{{ .Branch }}-{{ checksum "package.json" }}
#           paths:
#             - "node_modules"
#       - run: xvfb-run -a npm run test -- --watch=false --no-progress --browsers=ChromeNoSandbox
      # - run: xvfb-run -a npm run e2e -- --no-progress --config=protractor-ci.conf.js

#   deploy:
   
#     docker:
#         - image: circleci/node:6.14.1-browsers
#          working_directory: ~/CircleCI
#       steps:
#       - attach_workspace:
#          at: ~/CircleCI
#       - run:
#           name: Deploy
#           command: 'aws s3 sync ${build_folder}/ s3://${bucket}'

#  workflows:
#   version: 2
#   build-and-deploy:
#     jobs:
#       - build
#       - deploy:
#           requires:
#             - build
#           filters:
#             branches:
#               only: master


version: 2
jobs:
  build:
    working_directory: ~/CircleCI
    docker:
      - image: circleci/node:8-browsers
    steps:
      - checkout
      # - run:
      #     name: install-yarn
      #     command: 'curl -o- -L https://yarnpkg.com/install.sh | bash'
      - restore_cache:
          key: CircleCI-{{ .Branch }}-{{ checksum "package.json" }}
      - run: npm install
      - save_cache:
          key: CircleCI-{{ .Branch }}-{{ checksum "package.json" }}
          paths:
            - "node_modules"
      - run:
          name: build
          command: 'npm run build'
      - run: xvfb-run -a npm run test -- --watch=false --no-progress --browsers=ChromeNoSandbox

  deploy:
    working_directory: ~/CircleCI
    docker:
      - image: circleci/node:8-browsers
    steps:
          - run:
                name: Show current branch
                command: 'echo ${CIRCLE_BRANCH}'
          - run:
                name: Install aws cli
                command:
                    'sudo apt-get -y -qq install awscli'
          - run:
                name: Setting Signature Version 4 for S3 Request Authentication
                command: 'aws configure set default.s3.signature_version s3v4'

      - attach_workspace:
         at: ~/CircleCI
      - run:
          name: Deploy
          command: 'aws s3 sync dist s3://project-dev/ --delete'

workflows:
  version: 2
  build-and-deploy:
    jobs:
      - build
      - deploy:
          requires:
            - build
          filters:
            branches:
              only: master
